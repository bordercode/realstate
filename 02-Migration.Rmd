# Internal migration  patterns.


```{r, include= FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(plotly)
library(scales)
library(wesanderson)
library(readr)
library(ineq)
library(parsetR)
library(RColorBrewer)
library(leaflet)
library(leafem)
```


In this chapter, we explore the interplay among: geographic mobility of the population, income, and ethnicity, with a specific emphasis on analyzing out-of-state mobility for current residence at Metropolitan areas as the primary geographic unit of analysis. Drawing on economic theory, our study delves into the intricate dynamics that shape the patterns of population movement, shedding light on the factors influencing individuals' decisions to relocate across state lines. By examining the nexus of geographic mobility, income differentials, and racial composition, we aim to deepen our understanding of the complex interrelationships within metropolitan contexts and their implications for regional economic development with a focus on the Hispanic population. 

We initially consider housing demand in relation to income. According to the basic principles of human capital theory, lay out during the last century by pioneer scholars such as: Ted Schultz, Jacob Mincer, Milton Friedman, Sherwin Rosen and of course, Gary Becker in his classic book:  Human Capital: A Theoretical and Empirical Analysis with Special Reference to Education [@beckerInvestmentHumanCapital1962],  income is determined among other factors, by education attainment levels,  both formal as represented by a particular schooling degree or a specific job training. 

Age, which captures experience and skills acquired overtime [@stiglitzAlternativeTheoriesInequality2022] and several personal characteristics that may include gender [@reardonIncomeInequalityIncome2011] and ethnicity [@goetzRaciallyConcentratedAreas2019], a particular important factor in the context of a diverse country like the US. 

Together this factors impact productivity, determining earnings potential and actual income levels across occupations [@dumenilChangingPatternsIncome2022] and industries. 

In the context of the housing market, empirical evidence suggest that less educated households are less likely to be homeowners, [@choiHeterogeneousEffectsInteractions2022], furthermore,  education inequality could be a factor contributing to an increasing lack of housing affordability in Metropolitan areas associated with particular highly skilled labor markets. 

Data on US population growth, shows that cities with more educated residents have grown faster than comparable cities with less human capital [@glaeser2004rise]. This environment, in turn creates a cycle where some areas of the country are more attractive to specific population groups [@berryDivergenceHumanCapital2005; @choiWageTrickleRent2021] and at the same time generate incentives to migrate elsewhere for particular demographic segments as they are being priced-out of the housing market. 



## Data and Methods

In this chapter the main source of information analyzed is the American Community Survey (ACS) 5 year estimates for the period 2017-2021. This official data set is the premier source for detailed population and housing information in the US. It is collected by the US Census Bureau and is publicly available for a wide set of geographical scales including Metropolitan Statistical areas (MSAs).   

Although other temporal report formats are available for the ACS, this investigation choose the 5 year estimates for the most up to date release available at the moment of conducting this research given its reliable representativeness of the US population and its wide geographic coverage which allows to detect detailed spatial patterns.  

To retrieve the data, Census API endpoints calls are made using Python on jupyter notebooks environment. The visualization and data management is done with R studio´s Rmarkdown integrated development environment.

In a first stage, exploratory data analysis is conducted to determine which MSA are receiving population coming from out of the state, For this purpose the variable *Geographical mobility in the past year by age for current residence in the United States*, (for Population 1 year and over in the United States) is considered.

Although we are interested in documenting the magnitude of this flows, absolute values offer only a partial perspective of the relative importance of such incoming population movements. Thus,  in order to control for the relative MSA size and important population characteristics such as ethnicity, we proceed to estimate a location quotient (LQ), this is a classical indicator commonly applied in regional science analysis based on the following specification $$LQ=\frac{A}{B}$$ where $A=\frac{PI_i}{\sum_{i=1}^{384}PI}$ and $B=\frac{P_i}{\sum_{i=1}^{384}P}$

In this particular case, **LQ** estimation considers the following variables: 

$PI_i=B07004I005E$ Where **B07004I_005E** is table id for data on Geographical mobility in the past year (Hispanic or Latino) for current residence in the United States for $MSA_i$. PI, represents the total population count of this variable for the 384 MSA included in the study.  So in essence **A** measures the proportion or relative importance that Hispanics moving from out of state in MSA_i, represent among the total population that moved from out of state for the reference period. 


$P_i=B07001065E$  where **B07001_065E**  is table id for data on Geographical mobility in the past year for current residence in the United States, category: Moved from different state, for $MSA_{i}$  And P, is the total for the 384 MSA considered in the study.  So in essence **B** measures the proportion that MSA represents within the total US MSA set. 


As can be seen from the specification, LQ is a relative measure, that captures the geographic concentration of a particular variable relative to a reference area. 

To contribute to study housing affordability, in relation to internal migration flows, in section 2.3 I propose a classification for housing prices levels. By employing this classification framework, we can gain valuable insights into the varying degrees of housing affordability among destination states.

This scale encompasses four distinct categories that correspond to the distribution of the regional price parity (RPP) indicator across states. The reference values for these categories are as follows: "High cost" (RPP > 125), "Expensive" (125 >= RPP > 110), "Affordable" (110 >= RPP > 70), and "Low cost" (RPP < 70). 


## Moving across state borders.  

How real estate market dynamics and home prices in particular are driving the geographic mobility of the US population across state boundaries?  To analyze this issue we focus in the out of state population movement within US (MSAs).

Figure 1, showns which Metropolitan areas have been attracting the most out of state population in the period 2017-2021.

**Figure  1. Population moving from out of state by MSA of current residence in 2021**

```{r, echo=FALSE, warning=FALSE, message=FALSE}

border_st<-data.frame(state=c("TX", "CA","NM","AZ"))

#  Source 2017-2021 ACS 5-Year estimates 
#  API call  url="https://api.census.gov/data/2021/acs/acs5?get=NAME,B07001_065E&for=metropolitan%20statistical%20area/micropolitan%20statistical%20area:*&key={0}".format(census_api_key)	

df_2021<-readRDS("B07004X_005E.rds")%>%
  mutate(state = str_extract(State, "\\b[A-Z]{2}\\b"),
  border=as.factor(ifelse(state%in%border_st$state,"BorderUS-MX","No Border")))
  
#saveRDS(df_2021,"df_2021.rds")

top20<-df_2021%>%
  rename(Pop=B07001_065E)%>%
mutate(MSA=fct_reorder(City, Pop), border=as.factor(ifelse(state%in%border_st$state,"BorderUS-MX","No Border")))%>%
slice_max(MSA,n=20)%>%
  select(Pop, City, state,border)%>%
  rename(MSA=City, MoveinPop=Pop)



top20_mig<-ggplot(top20, aes(MoveinPop, reorder(MSA,MoveinPop), label=MSA,fill=border, text=state))+
  geom_col()+
  scale_fill_manual(values = c("#3B9AB2", "#78B7C5"), name="") +

  labs(
    x = 'Population moving from out of state',
    y = 'Metropolitan statiscal areas (MSAs)')+
  theme(legend.position="bottom")

ggplotly(top20_mig, tooltip=c("text", "MoveinPop", "MSA" ))%>%
  layout(legend = list(orientation = "h", x = 0, y = -.05))


# Although Border MSA  are not particularly important destinations for in migration for the total population,  San Diego is the only MSA that is part of the top 20 MSA receiving the largest inflows in the country. Some other MSA located in Border states but not in border adjacent areas with Mexico that form part of the top 20 list are the following.  

# Dallas-Fort Worth-Arlington, TX Metro Area rank 5
# Los Angeles-Long Beach-Anaheim, CA Metro Area  8
# Houston-The Woodlands-Sugar Land, TX Metro Area 12
# San Diego-Chula Vista-Carlsbad, CA Metro Area 18
```
Source: José Luis Manzanares Rivera with data from:  Rivera[@uscensusbureauAmericanCommunitySurvey2021]

According to ACS 2017-2021. 5 year estimates. New York-Newark-Jersey City, Washington-Arlington-Alexandria and Phoenix-Mesa-Chandler, AZ Metro Area received the greatest flows of inter state migration in this period. 

Although Border MSA are not particularly important destinations for in migration considering the total population,  the border MSAS of San Diego-Chula Vista-Carlsbad, CA is the only MSA that is part of the top 20 MSA´s by its magnitude of inflows in the country. 

Some other MSA located in border states but not in border adjacent areas with Mexico that form part of the top 20 list are the following:  Dallas-Fort Worth-Arlington, TX Metro Area which ranks $5^{th}$, Los Angeles-Long Beach-Anaheim, CA Metro Area $8^{th}$ place and Houston-The Woodlands-Sugar Land, TX Metro Area, occupying $12^{th}$ position.

This base scenario considers the total population, however, by incorporating population ethnicity as a control variable, we gain insights into the geographical preferences of different racial groups, including Hispanics, Blacks, Whites, and Asians. This enables us to determine whether certain cities with higher living costs exhibit a greater attraction for specific population segments. 

Additionally, we can identify the areas that are comparatively less appealing to each racial group. This analysis provides valuable information regarding the underlying factors that influence migration patterns and population dynamics.

**Figure 2  Hispanics moving from out of state by current MSA residence. % of total population moving from out state 2021**

```{r, echo=FALSE, warning=FALSE, message=FALSE}

df_2021<-readRDS("df_2021.rds")
# Where does Hispanics mostly migrate to?

top20I<-df_2021%>%
mutate(MSA=fct_reorder(City, p_hisp))%>%
slice_max(MSA,n=20)%>%
  select(p_hisp, City, state,border)%>%
  rename(Percent=p_hisp)

## plot  Hispanics moving from out of state  % of total population moved from out state. 

top20_hisp<-ggplot(top20I, aes(Percent, reorder(City,Percent), label=City,fill=border, text=state))+
  scale_fill_manual(values = c("#A93226","#34495E"), name="") +
  geom_col() +

  labs(
    x = '(% of total pop moved out state)',
    y = 'Metropolitan statiscal areas (MSAs)')+
  theme(legend.position="bottom")

ggplotly(top20_hisp, tooltip=c("text", "Percent", "City" ))%>%
  layout(legend = list(orientation = "h", x = 0, y = -.05))

## 70% of the MSA where the majority of Hispanic population migrated are located in the border with mexico.  The highest recipient being McAllen-Edinburg-Mission, followed by Brownsville-Harlingen and  Laredo. All of theme in Texas Lower Rio grande region. a low cost low income, High poverty rate area. 

###############################

## questions to be aswered with this data> 

## Where does Asians migrate to? 

## What is the demographic composition of the migration flows for the  high priced areas. Ej. Sunnyvale , Are Hispanics migrating to Bay area?

# What is the Mortgage to income rate for  expensive areas?
# What is the homeless rate for high price areas. 

```

Source: José Luis Manzanares Rivera based on data form ACS 5 year estimates.  [@uscensusbureauAmericanCommunitySurvey2021]

We find that 70% of the MSA where the majority of Hispanic population migrated to, are located in the border with México. The highest recipient being McAllen-Edinburg-Mission, followed by Brownsville-Harlingen and  Laredo, all of theme in the Texas Lower Rio grande Valley region, a low cost low income, high poverty rate area.

Considering the above raking we find a pattern Comprised of MSA´s where the common feature is a particular economic structure suited for labor intensive productive activities. 

In this pattern we have Dalton, Georgia, Yakima Washington and Grand Island, Nebraska MSA´s. 

Dalton is an area home of the nation's floor-covering manufacturers hub and often referred as the *Carpet Capital of the World*. A great account about the history of the carpet industry in this city and its related labor market development during the industry´s boom can be found in the work by [@pattonWorldOpportunityTufting1997]. Today Dalton, Georgia is a metropolitan area with a demographic structure with a majority Hispanic population, a feature that is indeed unique out of the border state region. 

As the case above, Yakima Metropolitan Statistical Area (MSA), situated within the state of Washington, is another region out of the US-Mexico border that make up the top 20 destinations for Hispanics moving out of state.

This region has a unique labor market structure, in this case with an historical reliance on agriculture, specifically fruit production.
This agricultural focus has led to a labor market  characterized by seasonal fluctuations in demand which employs a diverse workforce [@bentleyYakima2016], including unskilled laborers who engage in tasks such as picking and packing crops. According to the US Census Bureau the Hispanic or Latino community constitutes $58.9\%$ of the population, a considerable higher proportion than the State´s proportion of $13\%$ [@uscensusbureauacsUSCensusBureau2022]. 

Similarly the case of Grand Island, Nebraska, situated within a predominantly agricultural region features a local economy that includes an important food processing and manufacturing activity that heavily relies on a labor intensive workforce. According to the US Census Bureau, the Hispanic segment in the area represents $33\%$ of the total population. [@uscensusbureauPopulationEstimatesEstimated2023]. 

What about migration patterns between racial groups. Where are Asians mostly moving to? What about Blacks. We know where are Hispanics moving to but what about the White population.
To explore this particular aspects of internal migration process, we estimate the Location Quotient (LQ) for the main racial categories included in the American community survey  estimates. 
Figure 3 show results for Asians, Blacks and the White  non Hispanic population.

**Figure 3 MSA destinations for out of state migrants by race as measured by Location Quotient 2021**

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(wesanderson)
library(leaflet)
library(mapview)
library(leafem)
library(sf)

#asians<-rate_D%>%mutate(race="Asian")%>%select(City, State, lq, race)%>%  separate(City, into= c("MSA", "city2"), sep="-", remove = FALSE)%>%separate(State, into = c("state", "state2"), sep = "-", remove = )%>%select(MSA, state, lq, race)%>%mutate(MSA_State = paste(MSA, state, sep = ", "))#

asians<-read.csv("asians.csv")
asians_df <-asians%>% st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326)

rate_B<-readRDS("rate_B.rds")

blacks<-rate_B%>%select(City, State, lq)%>%  separate(City, into= c("MSA", "city2"), sep="-", remove = FALSE)%>%separate(State, into = c("state", "state2"), sep = "-", remove = )%>%select(MSA, state, lq)%>%mutate(MSA_State = paste(MSA, state, sep = ", "))%>%  rename(lq_blacks=lq)%>%left_join(asians)%>% select(-X, -lq,-race, -MSA)

blacks_df <-blacks%>% st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326)

rate_H<-readRDS("rate_H.rds")

whites<-rate_H%>%select(City, State, lq)%>%  separate(City, into= c("MSA", "city2"), sep="-", remove = FALSE)%>%separate(State, into = c("state", "state2"), sep = "-", remove = )%>%select(MSA, state, lq)%>%mutate(MSA_State = paste(MSA, state, sep = ", "))%>%
  rename(lq_Whites=lq)%>%left_join(asians)%>%
  select(-X, -lq,-race, -MSA)

whites_df <-whites%>% st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326)


mapa<-mapview(asians_df, map.types =  "CartoDB.Positron",cex="lq", zcol="lq", col.regions = wes_palette(n = 5, name = "Zissou1"),layer.name= "Asians",homebutton =TRUE)+ 
mapview(blacks_df, map.types =  "OpenStreetMap.DE",cex="lq_blacks",  col.regions = wes_palette(n = 5, name = "Zissou1"),zcol="lq_blacks", layer.name= "Blacks",homebutton =FALSE) +
mapview(whites_df, map.types =  "OpenStreetMap.DE",cex="lq_Whites", col.regions = wes_palette(n = 5, name = "Zissou1"), zcol="lq_Whites", layer.name= "Whites",homebutton =FALSE)


leafem::addMouseCoordinates(mapa)%>%setView(zoom = 3.6, -96.5716694, 39.1836082)

```
Source: José Luis Manzanares Rivera based on data from ACS 5 years estimates.  [@uscensusbureauAmericanCommunitySurvey2021]


From the location quotient estimation we find that Asians are primarily migrating towards College towns and tech hub markets. The top five concentration MSA'S are: Ithaca, NY home to Cornell University which is routinely ranked among the world's best universities 	which exhibits a concentration ten times higher than Asian's out of state migration levels in the country  (LQ=10.47).

Lafayette-West Lafayette, IN, MSA home of Purdue University which is a major research institution known for discoveries in science, technology, engineering and math. Shows a LQ=4.18.

San Jose-Sunnyvale-Santa Clara MSA, an area with world wide recognition as a hub for technology sector. With a LQ=3.68

Ann Arbor, Michigan an area home to the University of Michigan which is considered to  be one of the top public research universities in the country and it is a leader in various fields, including medicine. With a LQ=3.62.

Seattle-Tacoma-Bellevue MSA, another area with increasingly important activity in the tech sector, with a labor market linked to silicon Valley companies such as Microsoft, Amazon, Facebook and Google. With a concentration three times that observed by this population group at the country scale (LQ=3.36).

For the black population the highest relative concentrations of out of state migrants are mostly found in Military base related towns:  Hinesville, GA, (LQ=9.28), home of the Fort Stewart military installations which are the largest Army installation east of the Mississippi River, covering 280,000 acres (1,100 km2). 


Killeen-Temple, TX, which host Fort Hood, an army complex which is among the largest United States military installations worldwide (encompasses 340 square miles (bigger than the city of Dallas, TX) and employs about 37,000 military personnel) and is home to many units, such as the 1st Cavalry Division, 4th Infantry Division, Command III Corps, 504th Military Intelligence Brigade, 21st Cavalry Brigade Air Combat. (LQ=5.04). 


Clarksville, TN, a MSA which host Fort Campbell, a United States Army installation where aircraft training operations are conducted. LQ=4.97.
Lawton, OK. (LQ=4.73) a MSA  in close proximity to military operations base Fort Sill, which is one of the four locations for Army Basic Combat Training. And Columbus, GA (LQ=4.07) an area that host Fort Moore, the United States Army's maneuver center of excellence and a major employer, is located south of the city in southern Muscogee and Chattahoochee counties. It supports more than 120,000 active-duty military, family members, reserve component soldiers, retirees and civilian employees on a daily basis.

Concerning the White non Hispanic population it is also of interest to note the places that are the least preferred to migrate. The bottom 5 MSA in this regard  lay right at the US-Mexico Border. With Laredo, Tx, being the MSA with the lowest concentration of out of state white movers, followed by the Brownsville-Harlingen, TX, MSA, Madera, CA, 	
McAllen-Edinburg-Mission, Tx and 	
Vineland-Bridgeton, New Jersey.


Now we consider important housing demand side determinants in particular we are interested in the association between income, Metropolitan area size as measure by its population and personal income. 

## Housing demand determinants: population growth, income and home prices

Basic economic theory suggest that housing demand is influenced by specific demographic factors. Population growth is a paramount factor, in particular the interaction between population outflows and those incoming that define net migration, shape housing demand which in turn, given the scarcity principle that ultimately rules all human endeavor,  ensures an upward signal from the pricing system. 

Although subtle attraction elements of each geographic area contribute to shape migration patterns, it is the net population movement that manifest to balance supply and demand. But why population moves?  Centrally another economic variable plays a key role to understand incentives to relocate or the basic decision to acquire a home. That is income, per capita income, which is directly related to labor market dynamics in a given moment in time. 

Despite that home values by themselves act as signals to achieve  demand and supply equilibrium, this important factor can be particularly volatile when considering the real estate market environment, given that forces such as expectations play a pivotal role, home prices fluctuations can be particularly susceptible to the wider macroeconomic policy decisions. 

The following figure considers data on the factors discussed above, for all Metropolitan statistical areas located at the US Mexico border States. The aim of the analysis is to capture the relationship among this important factors and distinguish patterns within the US-Mexico border region.   


**Figure 3 Housing market determinants: HPI, population and percapita income 2020**
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8}

## THIS IS THE PLOT  income,  population,   hpi  2020 for border states msa.

## HPI Source> https://www.fhfa.gov/DataTools/Tools/Pages/Four-Quarter-Heat-Map.aspx


only_border2020<-readRDS("df_inc_pop_hpi2020.rds")%>%
  mutate(state=as.factor(state))

p <- ggplot(only_border2020, aes(pp_inccome, hpi, size = Population, colour = state, label=msa)) +
  geom_point(alpha = 0.7) +
  scale_size(range = c(1, 6))  +
  scale_colour_manual(values = c("red","blue", "darkgoldenrod4", "grey"))+
labs(x = 'Per capita personal income 2020', y = 'HPI 1991=100', colour = "state", size="HPI", caption="Source: Federal Housing Finance Agency. 2023") +
scale_x_log10(labels =  comma ) +
geom_hline(yintercept=median(only_border2020$hpi), linetype="dotted", color="black")+
geom_vline(xintercept =mean(only_border2020$pp_inccome), linetype="dotted", color="black")+
geom_smooth(method="lm", se=FALSE, linewidth=.2 )+
theme_classic()+
annotate("text", x=100000, y=270, size=3.1,label="Median HPI")

ggplotly(p,tooltip = c("label","colour","x", "size", "hpi"))%>% 
  layout(
  legend = list(orientation = 'h', x = 0.3, y = -0.13,title=list(text="State")))

#htmlwidgets::saveWidget(  widget = f9, #the plotly object
                      #file = "C:/Users/josel/Desktop/on/I/2023/HOUSING/realstate/speech/F9_scatter.html", 
#the path & file name
#selfcontained = TRUE #creates a single html file)


## Methodology note:  Data considers Purchase only, PO.  quarterly for MSA  base 1991-Q1. FHFA. https://www.fhfa.gov/DataTools/Downloads/Pages/House-Price-Index.aspx. 

# Detailed source site for smaller areas Such as Census tracks.  https://www.fhfa.gov/DataTools/Downloads/Pages/House-Price-Index-Datasets.aspx#qpo
```
Source: José Lus Manzanares Rivera base on data from Federal Housing Finance Agency  [@fhfaHousePriceIndex2022, @bureauofeconomicanalysisPersonalIncomeCounty2023]

Although data provides sound evidence that personal per capita income and house prices are positively correlated, degrees of correlation varies between border state´s metropolitan areas, with the strongest relationship being observed by Californian MSA, where we also find the most expensive metropolitan areas of the border states considering housing prices. 

In addition, there is only a weak positive relationship between house prices as measured by the HPI and population size, this is the case for New Mexico, where relative large size metropolitan areas such as Albuquerque still exhibit affordable house prices. Population size being a proxy for housing demand. 

While this pattern found makes sense considering the basic principles of economics concerning scarcity, it also suggest that other factors influence house price fluctuations, including the underlying labor market structure and demand for highly skilled labor force, which is certainly the case for metropolitan areas located near the Silicon Valley region in California such as the San Jose-Sunnyvale-Santa Clara (MSA), which is the most expensive metropolitan area in the whole country considering the house price index for 2022, but is not necessarily a big size metropolitan area.


Secondly, using a Cartesian approach to analyze resulting patterns from the above data representation, and dividing the  plot into four quadrants:  starting with the top right section being quadrant one, where the combination of higher than average house prices and  higher than average income levels are found and moving counter clock wise towards quadrant four, formed by the combination of higher than average personal income together with lower than average house prices levels. 

We found that within the subset of MSAs that are located along the US-Mexico border, 95% lay inside the third quadrant, where there is a combination of below average personal income with relatively inexpensive house prices, Whereas only one  MSA in this particular geographic region, is situated at the first quadrant, that is the San Diego-Chula vista-Carlsbad in California´s southern border. 

 
This feature denotes a very different set of economic dynamics for the local movement of people across the border, making San Diego-Chula Vista-Carlsbad a very prone area for out migration, including cross border migration given the real estate market price differentials combined with the economic integration that bi national trade and manufacture hubs have developed across the border in o the Mexican metropolitan area of Tijuana.   

Furthermore, considering the information for year 2020, there is evidence of sharp differences among border metropolitan areas ^[defined for the purposes of this investigation as urban areas that lay  along the border line] house prices. 

It is observed that for example that El Paso, TX, the second largest metropolitan area along the US-Mexico border, has a HPI 70% lower than  San Diego´s, CA (MSA), the city across Tijuana.  These patterns provide evidence of the relevance to study the housing markets in specific locations along the US-Mexico border, Tijuana-San Diego being an relevant case study.  


```{r, include=FALSE}
#full<-readRDS("B07004X_005E.rds")
#xmig<-read.csv("x_mig.csv")%>%  rename(GEO_Code=metropolitan.statistical.area.micropolitan.statistical.area)%>%left_join(full)%>%na.omit

```


```{r, include=FALSE}

full<-readRDS("B07004X_005E.rds")

mig<-read.csv("all_mig.csv")%>%  rename(GEO_Code=metropolitan.statistical.area.micropolitan.statistical.area)%>%left_join(full)%>%na.omit

mig <- mig %>%
  mutate(City = str_extract(NAME, "^[^,]+"),
         State = str_extract(NAME, "\\b[A-Z]{2}\\b"),
         Area = str_extract(NAME, "\\b[^,]+$"))

mig <- mig %>%
  separate(Area, into = c("State", "type"), sep = "\\s", remove = FALSE)%>%
filter(type!="Micro")%>%
na.omit

##mutate(t.mig=sum(B07001_001E), den=B07001_001E/t.mig, t.mig.I=sum(B07004I_005E), num=B07004I_005E/t.mig.I, lq_I=round(num/den,2))



#uspop<-read.csv("uspop.csv")

#lq<-mig%>%mutate(LQx=B07001_001E/B01001_001E)

# Do not run, DATA WRANGLING.

## Migration analysis from the 2021 ACS. 5yr data estimates.


#  API call  url="https://api.census.gov/data/2021/acs/acs5?get=NAME,B07001_065E&for=metropolitan%20statistical%20area/micropolitan%20statistical%20area:*&key={0}".format(census_api_key)	

## Additional sources: 
# Table shell list. 
# See files in ACS2020_Table_Shells.csv  in Analysis  folder from current  project path. C:\Users\josel\Desktop\on\I\2023\HOUSING\Analysis

## https://www.census.gov/programs-surveys/acs/technical-documentation/table-shells.html

# IMPORTANT REFERENCE SOURCE FOR TABLE ID'S

# https://www.census.gov/programs-surveys/acs/data/data-tables/table-ids-explained.html

geo_codes <- readRDS("geo_codes.rds")


B07001_065E <- read.csv("B07001_065E.csv")%>%
  rename(GEO_Code=metropolitan.statistical.area.micropolitan.statistical.area)


B07001_065E <- B07001_065E %>%
  mutate(City = str_extract(NAME, "^[^,]+"),
         State = str_extract(NAME, "\\b[A-Z]{2}\\b"),
         Area = str_extract(NAME, "\\b[^,]+$"))

B07001_065E <- B07001_065E %>%
  separate(Area, into = c("State", "type"), sep = "\\s", remove = FALSE)%>%filter(type!="Micro")


#^ indicates the start of a string. It ensures that the match starts from the beginning of the string.
#[^,] is a negated character class that matches any character except a comma (,). The ^ inside the character class negates the class, so [^,] matches any character that is not a comma.
# + means that the previous pattern (in this case, [^,]) should match one or more times. It allows the regular expression to match multiple non-comma characters in sequence.

# \\b is a word boundary anchor. It matches the position between a word character and a non-word character. In this case, it ensures that the state code is not part of a longer word.

# [A-Z]{2} is a character class that matches any uppercase letter (A to Z). The {2} quantifier specifies that exactly two uppercase letters should be matched consecutively.

# \\b is another word boundary anchor that ensures the state code is not part of a longer word.

#####################
# HISPANOS
########################


B07004I_005E <- read.csv("HISPMIG.csv")%>%
  rename(GEO_Code=metropolitan.statistical.area.micropolitan.statistical.area)


B07004I_005E <- B07004I_005E %>%
  mutate(City = str_extract(NAME, "^[^,]+"),
         State = str_extract(NAME, "\\b[A-Z]{2}\\b"),
         Area = str_extract(NAME, "\\b[^,]+$"))

B07004I_005E <- B07004I_005E %>%
  separate(Area, into = c("State", "type"), sep = "\\s", remove = FALSE)%>%filter(type!="Micro")


df<-left_join(B07004I_005E, B07001_065E)%>%
na.omit%>%
mutate(p_hisp=round(B07004I_005E/B07001_065E,2), t.osmig=sum(B07001_065E), den=B07001_065E/t.osmig, t.mig.I=sum(B07004I_005E), num=B07004I_005E/t.mig.I, lq_I=round(num/den,2))


#############
#  A
##############

A <- read.csv("AMIG.csv")%>%
  rename(GEO_Code=metropolitan.statistical.area.micropolitan.statistical.area)


A <- A %>%
  mutate(City = str_extract(NAME, "^[^,]+"),
         State = str_extract(NAME, "\\b[A-Z]{2}\\b"),
         Area = str_extract(NAME, "\\b[^,]+$"))

A <- A %>%
  separate(Area, into = c("State", "type"), sep = "\\s", remove = FALSE)%>%filter(type!="Micro")


df<-left_join(A, df)%>%
na.omit%>%
mutate(p_A=round(B07004A_005E/B07001_065E,2))

#############
#  B
##############

B <- read.csv("BMIG.csv")%>%
  rename(GEO_Code=metropolitan.statistical.area.micropolitan.statistical.area)


B <- B %>%
  mutate(City = str_extract(NAME, "^[^,]+"),
         State = str_extract(NAME, "\\b[A-Z]{2}\\b"),
         Area = str_extract(NAME, "\\b[^,]+$"))

B <- B %>%
  separate(Area, into = c("State", "type"), sep = "\\s", remove = FALSE)%>%filter(type!="Micro")


df<-left_join(B, df)%>%
na.omit%>%
mutate(p_B=round(B07004B_005E/B07001_065E,2))



#############
#  C
##############

C <- read.csv("CMIG.csv")%>%
  rename(GEO_Code=metropolitan.statistical.area.micropolitan.statistical.area)


C <- C %>%
  mutate(City = str_extract(NAME, "^[^,]+"),
         State = str_extract(NAME, "\\b[A-Z]{2}\\b"),
         Area = str_extract(NAME, "\\b[^,]+$"))

C <- C %>%
  separate(Area, into = c("State", "type"), sep = "\\s", remove = FALSE)%>%filter(type!="Micro")


df<-left_join(C, df)%>%
na.omit%>%
mutate(p_C=round(B07004C_005E/B07001_065E,2))

#############
#  D
##############

D <- read.csv("DMIG.csv")%>%
  rename(GEO_Code=metropolitan.statistical.area.micropolitan.statistical.area)


D <- D %>%
  mutate(City = str_extract(NAME, "^[^,]+"),
         State = str_extract(NAME, "\\b[A-Z]{2}\\b"),
         Area = str_extract(NAME, "\\b[^,]+$"))

D <- D %>%
  separate(Area, into = c("State", "type"), sep = "\\s", remove = FALSE)%>%filter(type!="Micro")


df<-left_join(D, df)%>%
na.omit%>%
mutate(p_D=round(B07004D_005E/B07001_065E,2))

#############
#  E
##############

E <- read.csv("EMIG.csv")%>%
  rename(GEO_Code=metropolitan.statistical.area.micropolitan.statistical.area)


E <- E %>%
  mutate(City = str_extract(NAME, "^[^,]+"),
         State = str_extract(NAME, "\\b[A-Z]{2}\\b"),
         Area = str_extract(NAME, "\\b[^,]+$"))

E <- E %>%
  separate(Area, into = c("State", "type"), sep = "\\s", remove = FALSE)%>%filter(type!="Micro")


df<-left_join(E, df)%>%
na.omit%>%
mutate(p_E=round(B07004E_005E/B07001_065E,2))

#############
#  F
##############

EFE <- read.csv("FMIG.csv")%>%
  rename(GEO_Code=metropolitan.statistical.area.micropolitan.statistical.area)


EFE <- EFE %>%
  mutate(City = str_extract(NAME, "^[^,]+"),
         State = str_extract(NAME, "\\b[A-Z]{2}\\b"),
         Area = str_extract(NAME, "\\b[^,]+$"))

EFE <- EFE %>%
  separate(Area, into = c("State", "type"), sep = "\\s", remove = FALSE)%>%filter(type!="Micro")


df<-left_join(EFE, df)%>%
na.omit%>%
mutate(p_F=round(B07004F_005E/B07001_065E,2))

#############
#  G
##############

G <- read.csv("GMIG.csv")%>%
  rename(GEO_Code=metropolitan.statistical.area.micropolitan.statistical.area)


G <- G %>%
  mutate(City = str_extract(NAME, "^[^,]+"),
         State = str_extract(NAME, "\\b[A-Z]{2}\\b"),
         Area = str_extract(NAME, "\\b[^,]+$"))

G <- G %>%
  separate(Area, into = c("State", "type"), sep = "\\s", remove = FALSE)%>%filter(type!="Micro")


df<-left_join(G, df)%>%
na.omit%>%
mutate(p_G=round(B07004G_005E/B07001_065E,2))

#############
#  H
##############

H <- read.csv("HMIG.csv")%>%
  rename(GEO_Code=metropolitan.statistical.area.micropolitan.statistical.area)


H <- H %>%
  mutate(City = str_extract(NAME, "^[^,]+"),
         State = str_extract(NAME, "\\b[A-Z]{2}\\b"),
         Area = str_extract(NAME, "\\b[^,]+$"))

H <- H %>%
  separate(Area, into = c("State", "type"), sep = "\\s", remove = FALSE)%>%filter(type!="Micro")


df<-left_join(H, df)%>%
na.omit%>%
mutate(p_H=round(B07004H_005E/B07001_065E,2))


df<-df%>%mutate(movein=p_hisp+p_B+p_C+p_D+p_E+p_F+p_H, err=ifelse(movein==1,0,ifelse(movein>=1,1,2)))

ggplot(df, aes(movein))+
  geom_density(fill="#69b3a2", color="#e9ecef", alpha=0.8)

errores<-df%>%group_by(err)%>%summarize(total= n())
names(  df)

#saveRDS(df, "B07004X_005E.rds") 
# # Moved from different state GEOGRAPHICAL MOBILITY IN THE PAST YEAR ACS from API CALL: B07004I_005="https://api.census.gov/data/2021/acs/acs5?get=NAME,B07004I_005E&for=metropolitan%20statistical%20area/micropolitan%20statistical%20area:*&key={0}".format(census_api_key)	

# we join 9 tables one for each ethnicity category. 

```

```{r, include=FALSE}

### DATA WRANGLING FOR MIGRATION RATES PER 1000 
## rate by 1000 from total  MSA pop Migration out of state 

## Here we read the custom data set called   B07004X_005E.rds which contains all the pupulation ethnicitys for category moved from other state.
all.ethnicitys<-readRDS("B07004X_005E.rds")

uspop<-read.csv("uspop.csv")%>%
  rename(GEO_Code=metropolitan.statistical.area.micropolitan.statistical.area)


uspop <- uspop %>%
  mutate(City = str_extract(NAME, "^[^,]+"),
         State = str_extract(NAME, "\\b[A-Z]{2}\\b"),
         Area = str_extract(NAME, "\\b[^,]+$"))

uspop <- uspop %>%
  separate(Area, into = c("State", "type"), sep = "\\s", remove = FALSE)%>%filter(type!="Micro")%>%
  select(GEO_Code,B01001_001E)
names(uspop)

all.ethnicitys<-left_join(uspop, all.ethnicitys)%>%
na.omit

#### 
den<-all.ethnicitys%>%summarize(den=sum(B07001_065E)/sum(B01001_001E))
lq<-all.ethnicitys%>%mutate(lqx=(B07001_065E/B01001_001E)/0.02315713)

A<-mig%>%summarize(A=sum(B07001_065E))
B<-mig%>%summarize(B=sum(B07001_001E))

aaa<-read.csv("all_mig.csv")
lq2<-mig%>%mutate( lqx=(B07001_065E/B07001_001E)/den)
names(mig)
#####
cities<-all.ethnicitys%>%select(GEO_Code, City, State)

#saveRDS(cities,"cities.rds")

allpop<-all.ethnicitys%>%select(GEO_Code,B01001_001E)

rates100k<-all.ethnicitys%>%select(GEO_Code, B07004G_005E, B07004F_005E, B07004E_005E, B07004D_005E,B07004C_005E,B07004B_005E,B07004A_005E,B07004I_005E,B07001_065E, B07004H_005E, B07004I_005E)


  long_data <- rates100k %>%
  pivot_longer(cols = starts_with("B0"),
               names_to = "table_id",
               values_to = "mig")%>%
    left_join(allpop)%>%
  mutate(rate = round(1000 * (mig / B01001_001E), 2))
  
# saveRDS(long_data, "rates_raw.rds")
```

```{r, include=FALSE, warning=FALSE, message=FALSE}

## This are the rates of migration from out of state  2017-2021
cities<-readRDS("cities.rds")  

long_data<- readRDS("rates_raw.rds")
  # Hispanics 
  rate_I<-long_data%>%filter(table_id=="B07004I_005E")%>%
    left_join(cities)%>%
    mutate(t.mig=sum(mig), num=mig/t.mig, t.pop=sum(B01001_001E), den=B01001_001E/t.pop, lq=round(num/den,2))
### Here we can see this raw rate bias, it favors structural demographic trends for example captures the effect of population moving to military bases and   colleges towns. 
  
## For Hispanics the highest raw rates are:   Jacksonville, NC, Hinesville, GA, Las Cruces, NM, Yuma,AZ, East Stroudsburg, PA
# The first is a large military base. and the second too with Fort Stewart, the largest U.S. Army installation by area in the eastern United States.
  
  # The bottom or places that are not destinations for hispanics are: 
#Wheeling, WV, Sheboygan,WI, Gadsden, AL,  Lewiston-Auburn,ME, Pine Bluff,AR
  
# Blacks
  rate_B<-long_data%>%filter(table_id=="B07004B_005E")%>%
    left_join(cities)%>%
    mutate(t.mig=sum(mig), num=mig/t.mig, t.pop=sum(B01001_001E), den=B01001_001E/t.pop, lq=round(num/den,2))%>%
  select(City, State, lq)
  
saveRDS(rate_B, "rate_B.rds")  
# The highest rate are in Hinesville, GA  (Military base related migration),  Killeen-Temple, TX, which is known as a military "boom town
  
# Asians alone no hispanic 
  
  rate_D<-long_data%>%filter(table_id=="B07004D_005E")%>%
    left_join(cities)%>%
    mutate(t.mig=sum(mig), num=mig/t.mig, t.pop=sum(B01001_001E), den=B01001_001E/t.pop, lq=round(num/den,2))

saveRDS(rate_D, "rate_D.rds")     
### Asians are migrating towards Colleges towns and tech hub markets.
  
  # Whites  alone no hispanic 
   rate_H<-long_data%>%filter(table_id=="B07004H_005E")%>%
    left_join(cities)%>%
    mutate(t.mig=sum(mig), num=mig/t.mig, t.pop=sum(B01001_001E), den=B01001_001E/t.pop, lq=round(num/den,2))%>%
  select(City, State, lq) 
   
saveRDS(rate_H, "rate_H.rds")   
   
## Interesante Aqui podemos conjuntar la idea de racial differentiation. the question here is what are the places towards which, the white population is not  migrating.   The bottom 5 are:  Mexican border towns: Laredo, Brownsville, Madera CA, Vineland-Bridgeton, NJ. (A black town) McAllen-Edinburg-Mission and 
```


```{r, include=FALSE}
## Flows. Data on net migration flow between (MSAs)
## Source> ACS 5 yr estimates 2016-2020.

#https://api.census.gov/data/2020/acs/flows/examples.html

# API CALL  flows="https://api.census.gov/data/2020/acs/flows?get=MOVEDIN,GEOID1,GEOID2,MOVEDOUT,FULL1_NAME,FULL2_NAME,MOVEDNET&for=metropolitan%20statistical%20area/micropolitan%20statistical%20area:*&key={0}".format(census_api_key)

flows<-read.csv("migration_flows.csv")%>%
rename(GEO_Code=metropolitan.statistical.area.micropolitan.statistical.area)


flows <- flows %>%
  mutate(City = str_extract(FULL1_NAME, "^[^,]+"),
         State = str_extract(FULL1_NAME, "\\b[A-Z]{2}\\b"),
         Area = str_extract(FULL1_NAME, "\\b[^,]+$"))

# saveRDS(flows, "netflows_2016-2020.rds")

geo_codes<-flows%>%select(GEO_Code, FULL2_NAME, City)
#######################################
```


## The California exodus.

As has been discussed in chapter 1, currently, the state of California features the most expensive real estate market in the country according to official estimations such as the Regional price parity housing component published by the Bureau of Economic Analysis  (BEA). 

In addition, empirical evidence from the American Community Survey (ACS) internal migration flows, indicate that California is a leading state concerning negative migration flows and has been consistently experiencing negative net flows from its main Metropolitan areas.

A question that is important to solve in the context is: Where are Californians moving to? Are they looking for more affordable locations?  How far are they moving? 

Considering net migration flows reported by the ACS, almost half of the population ($43\%$) that decided to migrate out to a different Metropolitan area, did it across state lines. In fact only $7\%$ of the total destinations documented in the period 2016-2020, correspond to: within the state movements. This reflects a dynamic demographic process with implications for both origin and destination MSAs, including tax revenue gains for the new host states along with infrastructure demands and increased pressures over key resources such as energy and water.  


In light of the previous research question, Figure 4 provides an analysis of the distribution of destination states for Californians, along with a classification of housing market affordability. 


**Figure 4, Net migration flows from California, by state and Regional price parities**

```{r, echo=FALSE, warning=FALSE, message=FALSE}

## California out of state migration
#### plot for  type of  state migration  Affordable or High cost


#netflows<-readRDS("netflows_2016-2020.rds")

#CA<-netflows%>%filter(State=="CA"&MOVEDNET<0)%>%group_by(FULL2_NAME)%>%  summarize(flow=sum(MOVEDNET))%>%mutate(City2 = str_extract(FULL2_NAME, "^[^,]+"),State2 = str_extract(FULL2_NAME, "\\b[A-Z]{2}\\b"),Area2 = str_extract(FULL2_NAME, "\\b[^,]+$"), type=ifelse(State2=="CA",1,0))%>%na.omit


#saveRDS(CA, "CA.rds")

####
#states_abreviations<-read.csv("states_code.csv")%>%filter(State!="AK"&State!="HI"&State!="DC",State!="PR")



#prices<-read.csv("prices.csv")%>%mutate(type=as.factor(type), type=ifelse(type==0, "Below avg", "Above avg"))%>%filter(!row_number() %in% 9)%>%filter(state!="Alaska" &  state!="Hawaii")%>%mutate(cost=ifelse(housing<=70,"Low cost",ifelse(housing>70&housing<=110,"Affordable",ifelse(housing>110&housing<=125,"Expensive","High cost"))))%>%mutate(state = ifelse(grepl("[A-Z]", state),gsub("([a-z])([A-Z])", "\\1 \\2", state),state))%>%left_join(states_abreviations)%>%select(State,cost,housing)

 #destination_ca<-readRDS("CA.rds")%>%filter(type==0)%>%mutate(moved=abs(flow), State=as.factor(State2))%>%group_by(State)%>%summarize(total=sum(moved))%>%left_join(prices)%>%na.omit%>%rename(Net.mig=total, RPP=housing )
 
 #saveRDS(destination_ca, "destination_ca.rds")

#class<-destination_ca%>%group_by(cost)%>%summarize(total=n())%>%mutate(prtop=total/sum(total))

## Plot 

destination_ca<-readRDS("destination_ca.rds")
 
typecost<-ggplot(destination_ca, aes(Net.mig, reorder(State,Net.mig), fill=cost, label=RPP, text=State ))+
scale_fill_manual(values=c("#409E65","orange", "#EF551F", "#5D8DE7"), name="")+  
geom_col()+
  labs(
    x = 'Net migration from California MSA',
    y = 'Destination State')+
  theme(legend.position="bottom")+
  theme_classic()

ggplotly(typecost, tooltip = c("text", "RPP", "cost", "Net.mig"))%>%
  layout(legend = list(orientation = "h", x = 0, y = -.05))

```

Source: José Luis Manzanares Rivera based on [@uscensusbureauacsCountyMCDtoCountyMCD2023]


In accordance with the findings, among those Californian households choosing to live in a different state, We can observe that the vast majority of movers ($81\%$) are choosing states classified as either affordable ($60\%$) or low cost ($21\%$). The main destination state is Texas followed by neighboring states: Arizona, Nevada and Oregon. 

Although inter state patterns above are informative of the overall preferences  of Californian internal migrants, it is important to determine which particular Metropolitan areas within these states have been the main destinations. 

To achieve this goal we now analyze the negative net migration flows by metropolitan area for the state of California. 

Figure 5 below shows results. In this representation, MSAs have been  classified to determine the housing market price level of the particular MSA using the House price index (HPI) from the Federal Housing Finance Agency (FHFA) for year 2016, which is the beginning year of the ACS sample period for migration flows 5 year release  estimates (2016-2020).  This year is selected to control the effect prior to the migration to the destination MSAs. 

The classification is based on four categories to measure a variable called savings potential (SP). The savings potential implicit by the move is defined by the fraction that the HPI gap represents relative to origin housing prices level.  For example if  an HPI in the origin MSA is 128 and the destination MSA´s HPI  is 103, then the Saving potential implicit by the move expressed as percentage would be 25/128= 19.5 percent.
It is important to notice that the HPI captures the evolution in time of house prices relative to a base year which is the same for all US MSA contained in the data set. 


```{r, include=FALSE}

##  Data wrangling only to gett net flows for CAlifornia. 

# Federal Housing Finance Agency  with   Base year  1995.
# Source> https://www.fhfa.gov/DataTools/Downloads/Documents/HPI/HPI_AT_metro.txt

FHFA.hpi<-read.csv("HPI_At_metro.csv")%>%
  mutate(hpi = as.numeric(hpi))%>%
  filter(year==2016)%>%
  group_by(MSA)%>%
  summarize(hpiq=mean(hpi))%>%
  separate(MSA, into = c("City", "State"), sep = ",\\s*", remove = FALSE)

summary(FHFA.hpi)



## Here !!!! Asign HPi for all origin and destination 

#Answer the following  Question  the movement was likely due to affordable home prices. If So then, the gap between hpi of origin versus desination should be  positive, that is average hpis from all contribtion origins are higher than the  hpi for  destimnation

 #If this pattern prevails for at leas 50+1 % of the destinations, then we can say that migration was driven by a serch of affordable housing. 

## FOREGET ABORU THE EXPENSIVE, HIGH OCST AND AFFORDABLE CLASSIFICATION.!!!! 

#####################################################

#ggplot(FHFA.hpi, aes(hpiq))+geom_density(fill="#69b3a2", color="#e9ecef", alpha=0.8)

#percentiles <- quantile(FHFA.hpi$hpiq, probs = seq(0.1, 0.9, by = 0.1))
#df_percentiles <- data.frame(Percentile = names(percentiles), Value = percentiles)


netflows<-readRDS("netflows_2016-2020.rds")

CA<-netflows%>%filter(State=="CA"&MOVEDNET<0)%>%
  group_by(FULL2_NAME)%>%
  summarize(moved=sum(MOVEDNET))%>%
  mutate(City = str_extract(FULL2_NAME, "^[^,]+"),
         State = str_extract(FULL2_NAME, "\\b[A-Z]{2}\\b"),
         Area = str_extract(FULL2_NAME, "\\b[^,]+$"), type=ifelse(State=="CA",1,0))%>%na.omit%>%
  filter(State!="DC")


tipo<-CA%>%group_by(type)%>%
  summarize(where=sum(moved))%>%
  mutate(proportion=where/sum(where))





CAlocals<-CA%>%
  filter(type==1)



## From those who moved out of CA, the majority moved to Texas and Arizona MSA.

ca_out<-CA%>%filter(type==0)%>%
  filter(State!="DC")%>%
mutate(moved=moved*-1)%>%
  left_join(FHFA.hpi, by=c('City', "State"))%>%
  na.omit

#mutate(cost=ifelse(hpiq>=205.1305,"High cost", ifelse(hpiq<205.1305&hpiq>=185.7063, "Expensive", ifelse(hpiq<185.7063&hpiq>=170.6170,"Affordable","Low cost" ))))

  

#COUNTS<-ca_out%>%group_by(cost)%>%count(cost)


### Plot #### 

#saveRDS(ca_out, "ca_out.rds")
```

```{r, include=FALSE, message=FALSE, warning=FALSE}

### Plot  top MSa destinations for CA movers by net flow #### 


# Where does Californians are moving to? 

# The Phoenix-Mesa-Chandler, AZ Metro Area was the main area for out migration for Californians moving to another MSA out the state with a net migration flow  -22,769 people for the 5 year  estimate in the period 2013-2020.


#ca_out<-readRDS("ca_out.rds")%>%rename(Population=moved)%>%arrange(desc(Population))%>%mutate(acumulado=cumsum(Population ), cdf=acumulado/sum(Population))%>%slice_max(Population, n=78)%>%rename(Netflow=Population)



############   Concentration fo net migration out of state flows #############



#ineq(ca_out$Population,type = "Gini")
#Lc(ca_out$Population, plot = TRUE)


#lorenzo<-data.frame(a=Lc(ca_out$Population, plot = TRUE)$L.general, MSA=Lc(ca_out$Population, plot = TRUE)$L, pop=Lc(ca_out$Population, plot = TRUE)$p )



####################################

#msap<-ggplot(ca_out, aes(Netflow, reorder(MSA,Netflow), label=City, text=State, fill=Netflow ))+geom_col()+scale_fill_gradient(low = "grey", high = "#FF0F0F", name="" )+labs(  x = 'Net migration from California MSA',y = 'Destination (MSAs)')+ theme(legend.position="bottom")+theme_classic()

#ggplotly(msap, tooltip=c("text",  "City", "Netflow"))%>%layout(legend = list(orientation = "h", x = 0, y = -.05))

# we observe a Gini coef =.71 which reflects a highly unequal pattern of concentration of movers in a tggh   MSA set. 
```

Although internal migrants moving out of California dispersed to virtually all geographic regions of the country, 80% of the total net flow of out of state migrants, moved to a highly concentrated fraction of places representing only 26% of the total 300 destination MSAs as shown in figure 4 above.   

Furthermore,  when we consider the housing market price differentials between origin and destination MSAs, it is found that  only 3.1 %  of the destinations present a negative HPI gap, (a negative HPI gap indicates a movement from a lower to a higher housing cost MSA). Once the magnitude of the net migration  by origin MSA flow is considered, the HPI gap proportion adjust to $6\%$ for movers to more costly areas. Which indicates that the vast majority $94\%$ of out of state migrants from California preferred a more affordable destination. 

```{r, include=FALSE}

## Do not run.

# Just a test plot to see HPI vs. magnitud of net flows for destination MSA for California out of state movers. 

#ca_out<-readRDS("ca_out.rds")

##p <- ggplot(ca_out, aes(hpiq, moved, label=City)) +geom_point(alpha = 0.7) +scale_size(range = c(1, 6))  +labs(x = 'HPI 1995=100', y = 'Net.mig') +scale_y_log10(labels =  comma ) +geom_smooth(method="lm", se=FALSE, linewidth=.2 )+theme_classic()

#p

# IMPORTANT Add to this data a categorical variable that classify  MSA according to Expensive, high cost , affordable and  low cost homes (HPI distribution). Are Californians moving to low cost MSA?  Further more is Phoenix a High cost MSA. 

## See https://personal.tcu.edu/kylewalker/interactive-flow-visualization-in-r.html
```


```{r, include=FALSE}

#netflows<-readRDS("netflows_2016-2020.rds")

#origin<-netflows%>%
#select(-FULL2_NAME)
####################################

## data wrangling only to get HPI  to join to migration flows

#subset_df <- origin[is.na(origin$hpiq) & !duplicated(origin$FULL1_NAME), ]


#subset_df<-subset_df%>%
  #filter(State!="PR")%>%
  #select(City)%>%
  #rename(new_city=City)%>%
 # mutate(City=c("Austin-Round Rock-Georgetown",
#"Boston", 
#"Chicago-Naperville-Evanston", 
#"Dallas-Plano-Irving", 
#"Detroit-Dearborn-Livonia", 
#"Hartford-East Hartford-Middletown", 
#"Johnstown", 
#"Los Angeles-Long Beach-Glendale",
#"Miami-Miami Beach-Kendall",
#"Morgantown", "Morristown",
#"New York-Jersey City-White Plains",
#"Philadelphia",
#"Poughkeepsie-Newburgh-Middletown",
#"San Francisco-San Mateo-Redwood City",
#"Seattle-Bellevue-Kent"))
  #left_join(FHFA.hpi)

#FHFA.hpi<-read.csv("HPI_At_metro.csv")%>%mutate(City = str_extract(MSA, "^[^,]+"),State = str_extract(MSA, "\\b[A-Z]{2}\\b"),Area = str_extract(MSA, "\\b[^,]+$"))%>%mutate(hpi = parse_number(hpi))%>%filter(year==2016) %>%left_join(subset_df)

#FHFA.hpi$City <- ifelse(is.na(FHFA.hpi$new_city), FHFA.hpi$City, FHFA.hpi$new_city)

#FHFA.hpi<-FHFA.hpi%>%select(-new_city)%>%group_by(City, State)%>%summarise(hpi=mean(hpi))

#########################################

# Do not run 

#Separate only   origin

#origin<-netflows%>%select(-FULL2_NAME)


#destination<-netflows%>%select(FULL2_NAME)%>%mutate(City = str_extract(FULL2_NAME, "^[^,]+"),State = str_extract(FULL2_NAME, "\\b[A-Z]{2}\\b"),Area = str_extract(FULL2_NAME, "\\b[^,]+$"))%>%select(-Area)%>%left_join(FHFA.hpi)%>%rename(City2=City, State2=State,hpi2=hpi)


#ori.des<-origin%>%cbind(destination )%>%
  #filter(State=="CA"&MOVEDNET<0, State2!="HI",State2!="AK",State2!="DC")%>%mutate(type=ifelse(State2=="CA",1,0))%>%na.omit%>%filter(type==0)%>%mutate(hpigap=hpi-hpi2)

###################################################

### This is the important data set to work on the final hpi classification for destination MSA.

# saveRDS(ori.des,"ori.des.rds")

#orides<-readRDS("ori.des.rds")
  
#gapsumary<-ori.des%>%group_by(FULL2_NAME)%>%
#summarise(gap=mean(hpigap))

#saveRDS(gapsumary,"gapsumary.rds")

#gapsumary<-readRDS("gapsumary.rds")

## plot hpi gap  not pondered 

#ggplot(gapsumary, aes(gap))+geom_density(fill="#69b3a2", color="#e9ecef", alpha=0.8)

# 11/350  Only 3.1 %  of the destinations present a negative hpi gap, (a negative HPi gap indicates a movement from a lower to a higher housing cost) of the movers did so to a higher cost area.
# Basically Californians where relocating to more affordable areas of the country. A

## Plot  density   

#ponderador<-ori.des%>%group_by(FULL1_NAME)%>%mutate(ponderador=MOVEDNET/sum(MOVEDNET), typemove=ifelse(hpigap>=0,"Cheaper","Expensive"))%>%mutate(weightgap=hpigap*ponderador)%>%group_by(FULL2_NAME)%>%summarise(gap2=mean(weightgap))

#saveRDS(ponderador,"ponderador.rds")

# Once the magnitud or the size of the net migration  by origin MSA flow is considered, the hpi gap proportion adjust to 6 % for movers to more costly areas. This is just complementary data to highlight that there was a relevant gap between orign  and destination MSA for out of state movers.  

#### HERERER HERER!! CREATE A CLSSIFICATION FOR THE HPI GAP NAD REPRENT  DDESTINATION MSA  BY ITS HPI GAP SIZE, THIS WILL INFORME ON THE HOUSING MARKET INCENTIVES AND OBSERVED   HOUSE PRICE DIFFERENCITIALS BETWEEN ORIGIN AND DESTINATON MSAS.

## The clasification name is housing market savngs potential, it has 4 categories representing saving potential . the grated teh positive gap the bigger the savingswtih the move. 

#ggplot(ponderador, aes(gap2))+
#geom_density(fill="#69b3a2", color="#e9ecef", alpha=0.8)


#saveRDS(ponderador,"ponderador1.rds")

#ponderador1<-readRDS("ponderador1.rds")

#Pop<-ponderador1%>%group_by(City2, State2)%>%summarize(Pop=abs(sum(MOVEDNET)))

#hpigap<-ponderador1%>%group_by(City2, State2)%>%summarize(hpigap=mean(hpigap))%>%left_join(Pop)

#all<-ponderador1%>%mutate(sp=hpigap/hpi)%>%group_by(City2, State2)%>%summarize(savings=mean(sp))%>%left_join(hpigap)

#all$Location <- paste(all$City2, all$State2, sep = ", ")

#write.csv(all,"all.csv")

#location_MSA<-read.csv("all_msa_CAout_geocoded.csv")%>%na.omit()

#location_MSA<-st_as_sf(location_MSA, coords = c("Longitude", "Latitude"),  crs=4326)  %>%select(savings, hpigap, Pop, geometry, Location)

#saveRDS(location_MSA, "location_MSA_coded.rds")

#location_MSA<-readRDS("location_MSA_coded.rds")


#### Here introduce the paarset flordiagram  and make a map !!!


#Expensive<-ponderador%>%filter(typemove=="Expensive")

## Cheaper areas   positive MSA hpI gaps

#hpigap_sizemove <- ggplot(Cheapermove, aes(ponderador, hpigap, label=City, color=typemove)) +geom_point(alpha = 0.7) +scale_size(range = c(1, 6))  +labs(x = 'Size of Moved', y = 'HPI Gap') +scale_x_log10(labels =  comma ) +geom_smooth(method="lm", se=FALSE, linewidth=.2 )+theme_classic()hpigap_sizemove

## Expensive areas   Negative Hpi gap
#hpigap_sizemove <- ggplot(Expensive, aes(ponderador, hpigap, label=City)) +geom_point(alpha = 0.7) +scale_size(range = c(1, 6))  +labs(x = 'Size of Moved', y = 'HPI Gap') +scale_x_log10(labels =  comma ) +geom_smooth(method="lm", se=FALSE, linewidth=.2 )+theme_classic()hpigap_sizemove

## The bigger the size of the population flowing out From a particular MSA, the lower the HPI gap. That is, bigger negative net migration movements took place between MSAs with smaller HPI gaps or more similar housing markets. In addition this negative relationship  is not significant for  movers between a low cost area and high cost MSA (negative Hpi gaps between orign and destination)  which indicates  that not necessarily big netfows take place to more expensive areas. 
```

Figure 5 below shows the geographic distribution of destinations adding the HPI gap between origin and destination along with the net flow and the housing market savings indicator which represent the percentage that the HPI gap between origin and destination, accounts relative to the origin home price level. 

**Figure 5  Net out of state migration flows from California by destination MSA, HPI gap and savings as % of origin HPI 2020.**

```{r, echo=FALSE, warning=FALSE, message=FALSE}

location_MSA<-readRDS("location_MSA_coded.rds")%>%
  rename(Netflow=Pop)%>%
mutate(savings=round(savings,2))  

allCA_out<-mapview(location_MSA, map.types =  "CartoDB.DarkMatter",cex="Netflow", zcol="savings", layer.name= "Savings %",legend = TRUE,homebutton =FALSE, col.regions=brewer.pal(9, "YlOrRd"), alpha.regions = 1, alpha = 0.2)


leafem::addMouseCoordinates(allCA_out)%>%
setView(zoom = 3.6, -96.5716694, 39.1836082)

```
Source: José Luis Manzanares Rivera based on data from [@uscensusbureauacsCountyMCDtoCountyMCD2023; @fhfaHousePriceIndex2022]


The main metropolitan destinations for Californians during the study period were:  Phoenix-Mesa-Chandler, Arizona, Las Vegas-Henderson-Paradise, Nevada, Boise City, Idaho  Denver-Aurora-Lakewood, Colorado and Houston-The Woodlands-Sugar Land, Texas. Whereas the top local (within state) destinations were:  Riverside-San Bernardino-Ontario, 
Sacramento-Roseville-Folsom, San Francisco-Oakland-Berkeley, Stockton and Bakersfield Metro areas.
It is interesting to note in the case of Riverside-San Bernardino-Ontario Metro area, it is a periphery location to Los Angeles, Which may in fact reflect a price-out effect from the more expensive Los Angeles-Long Beach-Anaheim Metro Area.

To undestand which counties are the ones that are sending migrants to other states, the following map represents intensity of net migration flows from California at a county level as captured by the American Community survey from the Us Census Bureau 5 year estimates for the period 2016-2020. 

Given the real estate market conditions already discused for California, the representation considers negative net out of state flows coming from counties in the golden state only, controling for those destinations with an anual net flow greater or equal to 500 people, a treshold determined according to the overall distribution of the migration flows.  

The categories for the level of intensity where defined as follows: **Strong**  if the net flow between the origin and destination county was greater or equal to 1017 people (which corresponded to the third  quartile of the distribution), **moderate**  if the net flow value ranged between the 3rd quartile and the median, and **light intensity** for those counties with values lower to the first quartile.  Thus, figure 6 provides further evidence of the relevance of community connections in the wake of ever increasing housing prices that pose unaffordability issues for households in a wide scale.

**FIgure 6 Origin-destination net migration intensity from California, 2020 by county**
```{r, echo=FALSE, warning=FALSE, message=FALSE}

library(geosphere)


b2a_geo<-read.csv("B2A_geo.csv")%>%mutate(flow=as.factor(ifelse(abs(Net_B2A)>=1017, "Strong", ifelse(abs(Net_B2A)>=706,"Moderate","Light"))))

flows <- gcIntermediate(b2a_geo[,3:2], b2a_geo[,6:5], sp = TRUE, addStartEnd = TRUE)

flows$Net_B2A <- b2a_geo$Net_B2A

flows$origin <- b2a_geo$origin

flows$destination <- b2a_geo$destination
flows$flow <- b2a_geo$flow

hover <- paste0(b2a_geo$origin, " to ", 
                b2a_geo$destination, ': ', 
                as.character(b2a_geo$Net_B2A))

custom_colors <- c("#FBF394", "#16E2CC", "#E21616")
pal <- colorFactor(custom_colors, b2a_geo$flow)

m<-leaflet() %>%
  addProviderTiles('NASAGIBS.ViirsEarthAtNight2012') %>%
  addPolylines(
    data = flows,
    color = ~pal(flow),  
    label = hover, 
    group = ~origin,
    weight = b2a_geo$Net_B2A*.005
  ) %>%
  addLayersControl(
    overlayGroups = unique(flows$origin),
    options = layersControlOptions(collapsed = TRUE)
  ) 
      
final<-leaflet::addLegend(m,
  pal = pal,
  values = flows$flow,
  title = "Migration Intensity")

  final  
```
Source: [@uscensusbureauacsCountyMCDtoCountyMCD2023]

Among the 19 counties that fit the criteria as origin Counties with negative net out flows of people in the state of California, the main counties for emigration (origin places) were: Los Angeles, San Diego, Orange and San Bernardino.

Several impacts and social process are influenced by housing market conditions and population movements across states. One such key issue of social concern is homelessness, this is a major problem that has been raising in the US, particularly evident in some of the richest metropolitan areas of the country highlighting an intriguing paradox. 

Homelessness is a phenomenon that has been studied by scientist with a great level of detail since the 1980s, nevertheless its persistence and in some cases, it´s growth, entiles an increasing attention from the public policy perspective as well as from the academic arena recently.

Many authors, including sociologist, [@desmondEvictionReproductionUrban2012], economist, [@quigleyHomelessAmericaHomeless2001], urban planners, [@wolchMalignNeglectHomelessness1993,] public policy scientist, [@ravenhill2008culture], geographers [@Dozier], psychologist [@gilmerFidelityHousingFirst2014; @byrneTestingAlternativeDefinitions2015], anthropologist, [@zimmerman2022using] or public health practitioners [@fazelHealthHomelessPeople2014; @suBehavioralHealthCare2023; @presnallPredictorsSelfreportedGeneral2023; @onapa], have conducted comprehensive investigations to provide answers to an issue that apparently reflects the inequalities of today´s society.

With no doubt, the topic is complex and multifaceted, nonetheless is indeed a relevant subject that needs to be addressed, if the current affordability crisis as depicted by the growing gaps in variables such as income to house price ratios or rent prices, should be understood.


Current public policy and regulation for the housing industry such as rent controls or eviction restrictions are but a reflection of a reality that indicates a need for integrated policies and structural changes.

This topic is dealt with in the following chapter, considering a vibrant region in California, whose implications extend beyond US borders. We aim to  explain the social processes that take place in the housing market in the context of the San Diego-Tijuana Border a region with unique characteristics that complement each other posing challenges and many opportunities. 

